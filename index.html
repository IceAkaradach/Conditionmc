<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บันทึกพารามิเตอร์เครื่องจักรเย็บผ้า</title>
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* กำหนดฟอนต์ Inter และความสวยงามพื้นฐาน */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1400px;
        }
        .table-container {
            overflow-x: auto;
        }
        /* Style for required fields in form (optional, but good practice) */
        .required-label::after {
            content: " *";
            color: #ef4444; /* red-500 */
        }
        /* Custom scrollbar for better look */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }
        .table-container::-webkit-scrollbar-thumb {
            background: #cbd5e1; /* slate-300 */
            border-radius: 4px;
        }
        .table-container::-webkit-scrollbar-track {
            background: #f1f5f9; /* slate-100 */
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto">
        <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-lg">
            <h1 class="text-3xl font-extrabold text-blue-700">⚙️ บันทึกพารามิเตอร์เครื่องจักรเย็บผ้า</h1>
            <p class="text-gray-600 mt-2">ระบบจัดการข้อมูล Model และ Part Name สำหรับการตั้งค่าจักรเย็บผ้า</p>
        </header>

        <!-- Loading Indicator -->
        <div id="loading" class="hidden fixed inset-0 bg-gray-800 bg-opacity-50 flex justify-center items-center z-50">
            <div class="bg-white p-6 rounded-lg shadow-xl flex items-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>
                <span class="text-lg font-medium text-gray-700">กำลังโหลดข้อมูล...</span>
            </div>
        </div>

        <!-- Toast Message for Success/Error -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
            <!-- Toast messages will be injected here -->
        </div>

        <!-- Filter Section -->
        <section id="filter-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ค้นหาพารามิเตอร์</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                <div>
                    <label for="model-filter" class="block text-sm font-medium text-gray-700 mb-1">Model:</label>
                    <select id="model-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition duration-150 ease-in-out">
                        <option value="">-- เลือก Model --</option>
                    </select>
                </div>
                <div>
                    <label for="partname-filter" class="block text-sm font-medium text-gray-700 mb-1">Part Name:</label>
                    <select id="partname-filter" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 bg-white shadow-sm transition duration-150 ease-in-out">
                        <option value="">-- เลือก Part Name --</option>
                    </select>
                </div>
                <div class="flex space-x-2">
                    <button id="apply-filter-btn" class="w-full flex-1 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300 ease-in-out shadow-md">
                        ค้นหา
                    </button>
                    <button id="add-record-btn" class="w-full flex-1 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition duration-300 ease-in-out shadow-md" onclick="openModal()">
                        + เพิ่มข้อมูลใหม่
                    </button>
                </div>
            </div>
        </section>

        <!-- Data Table Section -->
        <section id="data-section" class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ผลการค้นหา</h2>
            <div id="table-message" class="text-center text-gray-500 p-8 hidden">
                กรุณาเลือก Model และ Part Name เพื่อแสดงข้อมูล
            </div>
            <div class="table-container">
                <table id="data-table" class="min-w-full divide-y divide-gray-200 border border-gray-200 hidden">
                    <thead class="bg-blue-50">
                        <!-- Table Headers will be injected here by renderTable -->
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="data-table-body">
                        <!-- Table Rows will be injected here by renderTable -->
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Modal for Add/Edit Record -->
    <div id="record-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50 p-4" onclick="if(event.target.id === 'record-modal') closeModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 transform transition-all duration-300">
            <div class="flex justify-between items-center border-b pb-3 mb-4">
                <h3 id="modal-title" class="text-2xl font-bold text-blue-700">เพิ่มข้อมูลใหม่</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <form id="record-form">
                <input type="hidden" id="RowIndex" name="RowIndex">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    
                    <!-- Form Fields (Generated Dynamically or explicitly listed) -->
                    <!-- I'll list the key fields explicitly for simplicity and control -->

                    <!-- Model (Text Input) -->
                    <div>
                        <label for="Model" class="block text-sm font-medium text-gray-700 required-label">Model</label>
                        <input type="text" id="Model" name="Model" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- PartName (Text Input) -->
                    <div>
                        <label for="PartName" class="block text-sm font-medium text-gray-700 required-label">Part Name</label>
                        <input type="text" id="PartName" name="PartName" required class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- ProcessNo (Text Input) -->
                    <div>
                        <label for="ProcessNo" class="block text-sm font-medium text-gray-700">Process No.</label>
                        <input type="text" id="ProcessNo" name="ProcessNo" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- MachineNo (Text Input) -->
                    <div>
                        <label for="MachineNo" class="block text-sm font-medium text-gray-700">Machine No.</label>
                        <input type="text" id="MachineNo" name="MachineNo" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- ProcessName (Text Input) -->
                    <div>
                        <label for="ProcessName" class="block text-sm font-medium text-gray-700">ชื่อกระบวนการ</label>
                        <input type="text" id="ProcessName" name="ProcessName" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- ThreadNo (Text Input) -->
                    <div>
                        <label for="ThreadNo" class="block text-sm font-medium text-gray-700">เบอร์ด้าย</label>
                        <input type="text" id="ThreadNo" name="ThreadNo" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- NeedleNo (Text Input) -->
                    <div>
                        <label for="NeedleNo" class="block text-sm font-medium text-gray-700">เบอร์เข็ม</label>
                        <input type="text" id="NeedleNo" name="NeedleNo" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- StitchLength (Number Input) -->
                    <div>
                        <label for="StitchLength" class="block text-sm font-medium text-gray-700">ฝีเข็ม</label>
                        <input type="number" step="any" id="StitchLength" name="StitchLength" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- UpperTension (Number Input) -->
                    <div>
                        <label for="UpperTension" class="block text-sm font-medium text-gray-700">แรงตึงด้ายบน (N) STD + 3</label>
                        <input type="number" step="any" id="UpperTension" name="UpperTension" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- LowerTension (Number Input) -->
                    <div>
                        <label for="LowerTension" class="block text-sm font-medium text-gray-700">แรงตึงด้ายล่าง (N) STD + 3</label>
                        <input type="number" step="any" id="LowerTension" name="LowerTension" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- OuterFootPressure (Number Input) -->
                    <div>
                        <label for="OuterFootPressure" class="block text-sm font-medium text-gray-700">แรงกดตีนผีนอก (Kg) STD + 1</label>
                        <input type="number" step="any" id="OuterFootPressure" name="OuterFootPressure" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- InnerFootPressure (Number Input) -->
                    <div>
                        <label for="InnerFootPressure" class="block text-sm font-medium text-gray-700">แรงกดตีนผีใน (Kg) STD + 1</label>
                        <input type="number" step="any" id="InnerFootPressure" name="InnerFootPressure" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- StopperDistance (Number Input) -->
                    <div>
                        <label for="StopperDistance" class="block text-sm font-medium text-gray-700">ระยะ stopper ตะเข็บ (mm)</label>
                        <input type="number" step="any" id="StopperDistance" name="StopperDistance" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- AirPressure (Number Input) -->
                    <div>
                        <label for="AirPressure" class="block text-sm font-medium text-gray-700">แรงลม (bar)</label>
                        <input type="number" step="any" id="AirPressure" name="AirPressure" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- SpeedRPM (Number Input) -->
                    <div>
                        <label for="SpeedRPM" class="block text-sm font-medium text-gray-700">ความเร็วรอบ (rpm)</label>
                        <input type="number" step="1" id="SpeedRPM" name="SpeedRPM" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- ManSkill (Number Input) -->
                    <div>
                        <label for="ManSkill" class="block text-sm font-medium text-gray-700">Man skill ≥</label>
                        <input type="number" step="any" id="ManSkill" name="ManSkill" class="mt-1 block w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>

                </div>

                <!-- Footer Buttons -->
                <div class="mt-8 pt-4 border-t flex justify-end space-x-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">
                        ยกเลิก
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                        บันทึกข้อมูล
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal for Deletion -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden flex items-center justify-center z-50 p-4" onclick="if(event.target.id === 'confirm-modal') hideConfirmModal()">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm p-6 transform transition-all duration-300">
            <h3 class="text-xl font-bold text-red-600 mb-4">ยืนยันการลบ</h3>
            <p class="text-gray-700 mb-6">คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลนี้? การดำเนินการนี้ไม่สามารถย้อนกลับได้</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="hideConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150">
                    ยกเลิก
                </button>
                <button type="button" id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150 shadow-md">
                    ยืนยันการลบ
                </button>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        // URL ของ Google Apps Script Web App (Development URL)
        // **โปรดเปลี่ยนเป็น '.../exec' เมื่อ Deploy เป็นเวอร์ชันจริง**
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxhtcnpLgE1KXyvDPDBuljje234fdeahc7dIT8xWXGkQPlDfkNId1fkERPe20YeXTlL8A/exec';

        // Map Keys (เหมือนกับใน Code.gs)
        const KEY_MAP = {
            "Model": "Model",
            "PartName": "Part Name",
            "ProcessNo": "Process No.",
            "MachineNo": "Machine No.",
            "ProcessName": "ชื่อกระบวนการ",
            "ThreadNo": "เบอร์ด้าย",
            "NeedleNo": "เบอร์เข็ม",
            "StitchLength": "ฝีเข็ม",
            "UpperTension": "แรงตึงด้ายบน (N) STD + 3",
            "LowerTension": "แรงตึงด้ายล่าง (N) STD + 3",
            "OuterFootPressure": "แรงกดตีนผีนอก (Kg) STD + 1",
            "InnerFootPressure": "แรงกดตีนผีใน (Kg) STD + 1",
            "StopperDistance": "ระยะ stopper ตะเข็บ (mm)",
            "AirPressure": "แรงลม (bar)",
            "SpeedRPM": "ความเร็วรอบ (rpm)",
            "ManSkill": "Man skill ≥"
        };
        const HEADERS = Object.values(KEY_MAP);
        const KEYS = Object.keys(KEY_MAP);

        // DOM Elements
        const loadingEl = document.getElementById('loading');
        const modelFilterEl = document.getElementById('model-filter');
        const partnameFilterEl = document.getElementById('partname-filter');
        const applyFilterBtn = document.getElementById('apply-filter-btn');
        const dataTableBody = document.getElementById('data-table-body');
        const dataTable = document.getElementById('data-table');
        const tableMessage = document.getElementById('table-message');
        const recordModal = document.getElementById('record-modal');
        const recordForm = document.getElementById('record-form');
        const modalTitle = document.getElementById('modal-title');
        const confirmModal = document.getElementById('confirm-modal');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        let isFetching = false;

        // ====================================================================
        // --- API Helper Functions ---
        // ====================================================================

        /**
         * ส่ง request ไปยัง Google Apps Script (GET method)
         * @param {string} action - ชนิดของ action
         * @param {object} params - พารามิเตอร์สำหรับ GET
         */
        async function fetchData(action, params = {}) {
            if (isFetching) return;
            isFetching = true;
            loadingEl.classList.remove('hidden');

            const urlParams = new URLSearchParams(params);
            urlParams.append('action', action);
            const url = `${WEB_APP_URL}?${urlParams.toString()}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    return data.data;
                } else {
                    throw new Error(data.error || 'Failed to fetch data from server.');
                }
            } catch (error) {
                showToast('error', `เกิดข้อผิดพลาดในการโหลด: ${error.message}`);
                console.error('Fetch Error:', error);
                return null;
            } finally {
                isFetching = false;
                loadingEl.classList.add('hidden');
            }
        }

        /**
         * ส่ง request ไปยัง Google Apps Script (POST method)
         * @param {string} action - ชนิดของ action
         * @param {object} data - ข้อมูลที่จะส่ง
         */
        async function postData(action, data) {
            if (isFetching) return { success: false, error: 'Request in progress.' };
            isFetching = true;
            loadingEl.classList.remove('hidden');

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action, data }),
                });

                const result = await response.json();
                
                if (result.success) {
                    showToast('success', result.message || 'ดำเนินการสำเร็จ');
                } else {
                    throw new Error(result.error || 'Failed to process request.');
                }
                return result;
            } catch (error) {
                showToast('error', `เกิดข้อผิดพลาด: ${error.message}`);
                console.error('Post Error:', error);
                return { success: false, error: error.message };
            } finally {
                isFetching = false;
                loadingEl.classList.add('hidden');
            }
        }

        // ====================================================================
        // --- UI Logic & Data Rendering ---
        // ====================================================================

        /**
         * โหลดค่า Model และ Part Name ที่ไม่ซ้ำกันสำหรับ Dropdown
         */
        async function loadUniqueFilters() {
            const data = await fetchData('read_unique');
            if (data) {
                modelFilterEl.innerHTML = '<option value="">-- เลือก Model --</option>';
                partnameFilterEl.innerHTML = '<option value="">-- เลือก Part Name --</option>';

                data.uniqueModels.sort().forEach(model => {
                    modelFilterEl.innerHTML += `<option value="${model}">${model}</option>`;
                });
                data.uniquePartNames.sort().forEach(partName => {
                    partnameFilterEl.innerHTML += `<option value="${partName}">${partName}</option>`;
                });
            }
        }

        /**
         * ใช้ตัวกรองและแสดงข้อมูลในตาราง
         */
        async function applyFilter() {
            const model = modelFilterEl.value.trim();
            const partName = partnameFilterEl.value.trim();

            dataTableBody.innerHTML = '';
            dataTable.classList.add('hidden');
            tableMessage.classList.remove('hidden');
            tableMessage.textContent = 'กำลังโหลด...';

            if (!model || !partName) {
                tableMessage.textContent = 'กรุณาเลือก Model และ Part Name ให้ครบถ้วน';
                return;
            }

            const data = await fetchData('read_filtered', { model, partName });

            if (data && data.records) {
                renderTable(data.records);
            } else {
                tableMessage.textContent = 'ไม่พบข้อมูลตามตัวกรองที่เลือก';
            }
        }

        /**
         * สร้างตารางและใส่ข้อมูล
         * @param {Array<object>} records - ข้อมูลรายการพารามิเตอร์
         */
        function renderTable(records) {
            const tableHead = dataTable.querySelector('thead');
            const tableBody = dataTableBody;
            
            // 1. Render Headers
            tableHead.innerHTML = `
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                    ${HEADERS.map(header => `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${header}</th>`).join('')}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                </tr>
            `;

            // 2. Render Body
            tableBody.innerHTML = '';
            if (records.length === 0) {
                tableMessage.textContent = 'ไม่พบข้อมูลตามตัวกรองที่เลือก';
                dataTable.classList.add('hidden');
                tableMessage.classList.remove('hidden');
                return;
            }

            records.forEach((record, index) => {
                const row = tableBody.insertRow();
                row.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                // Row Number and ID (RowIndex from GAS)
                row.insertCell().textContent = index + 1;
                row.setAttribute('data-row-index', record.id); // record.id holds the RowIndex from GAS

                // Data Cells
                KEYS.forEach(key => {
                    const cell = row.insertCell();
                    cell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-700';
                    cell.textContent = record[key] !== null ? record[key] : '-';
                });

                // Action Cell
                const actionCell = row.insertCell();
                actionCell.className = 'px-6 py-4 whitespace-nowrap text-right text-sm font-medium';
                actionCell.innerHTML = `
                    <button onclick="openModal(${record.id}, this.parentNode.parentNode)" class="text-blue-600 hover:text-blue-900 mr-3 transition duration-150">แก้ไข</button>
                    <button onclick="showConfirmModal(${record.id})" class="text-red-600 hover:text-red-900 transition duration-150">ลบ</button>
                `;
            });

            dataTable.classList.remove('hidden');
            tableMessage.classList.add('hidden');
        }

        /**
         * แสดง Toast Notification
         * @param {string} type - 'success' or 'error'
         * @param {string} message - ข้อความ
         */
        function showToast(type, message) {
            const toastContainer = document.getElementById('toast-container');
            const color = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' 
                ? '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>'
                : '<svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>';

            const toast = document.createElement('div');
            toast.className = `p-4 flex items-center text-white rounded-lg shadow-lg ${color} transition-opacity duration-300 ease-in-out opacity-0`;
            toast.innerHTML = `${icon}<span>${message}</span>`;
            
            toastContainer.appendChild(toast);
            
            // Fade in
            setTimeout(() => {
                toast.classList.remove('opacity-0');
            }, 10);

            // Fade out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        // ====================================================================
        // --- Modal & Form Logic ---
        // ====================================================================

        /**
         * เปิด Modal สำหรับเพิ่ม/แก้ไข
         * @param {number} rowIndex - Row Index สำหรับการแก้ไข (เป็น undefined/null สำหรับเพิ่มใหม่)
         * @param {HTMLElement} rowEl - Element แถวข้อมูลสำหรับดึงค่ามาใส่ (เฉพาะตอนแก้ไข)
         */
        function openModal(rowIndex, rowEl) {
            recordForm.reset();
            recordForm.querySelector('#RowIndex').value = '';

            if (rowIndex && rowEl) {
                // Edit Mode
                modalTitle.textContent = 'แก้ไขข้อมูลพารามิเตอร์';
                recordForm.querySelector('#RowIndex').value = rowIndex;
                
                // Populate form fields
                const dataCells = rowEl.querySelectorAll('td');
                
                // Skip the first cell (index 0) which is the row number
                KEYS.forEach((key, index) => {
                    const cellValue = dataCells[index + 1].textContent;
                    const input = recordForm.querySelector(`#${key}`);
                    if (input) {
                        // Use raw value unless it's the placeholder '-'
                        input.value = cellValue === '-' ? '' : cellValue;
                    }
                });

                // Model และ PartName ต้องถูก Disable เมื่อแก้ไข
                document.getElementById('Model').disabled = true;
                document.getElementById('PartName').disabled = true;

            } else {
                // Add Mode
                modalTitle.textContent = 'เพิ่มข้อมูลใหม่';
                
                // Model และ PartName ต้องถูก Enable เมื่อเพิ่มใหม่
                document.getElementById('Model').disabled = false;
                document.getElementById('PartName').disabled = false;
                
                // Pre-fill Model and PartName from filter if selected
                document.getElementById('Model').value = modelFilterEl.value.trim() || '';
                document.getElementById('PartName').value = partnameFilterEl.value.trim() || '';
            }

            recordModal.classList.remove('hidden');
        }

        /**
         * ปิด Modal
         */
        function closeModal() {
            recordModal.classList.add('hidden');
            // Ensure Model/PartName are re-enabled after closing
            document.getElementById('Model').disabled = false;
            document.getElementById('PartName').disabled = false;
        }

        /**
         * จัดการการบันทึกข้อมูล (Submit Form)
         */
        recordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // 1. Collect data from form
            const formData = new FormData(recordForm);
            const data = {};
            for (const [key, value] of formData.entries()) {
                // Convert empty strings to null/undefined if necessary, or ensure numerical values are parsed
                data[key] = value.trim() === '' ? null : value.trim(); 
            }

            // 2. Perform save operation
            const result = await postData('save', data);

            // 3. Handle result
            if (result.success) {
                closeModal();
                // Reload filters and re-apply current filter
                await loadUniqueFilters();
                if (modelFilterEl.value && partnameFilterEl.value) {
                    applyFilter();
                } else {
                    // If no filter selected, just clear the table
                    dataTableBody.innerHTML = '';
                    dataTable.classList.add('hidden');
                    tableMessage.classList.remove('hidden');
                    tableMessage.textContent = 'กรุณาเลือก Model และ Part Name ให้ครบถ้วน';
                }
            }
        });


        // ====================================================================
        // --- Deletion & Confirmation Logic ---
        // ====================================================================

        let currentRowIndexToDelete = null;

        /**
         * แสดง Modal ยืนยันการลบ
         * @param {number} rowIndex - Row Index ของแถวที่จะลบ
         */
        function showConfirmModal(rowIndex) {
            currentRowIndexToDelete = rowIndex;
            confirmModal.classList.remove('hidden');
        }

        /**
         * ซ่อน Modal ยืนยัน
         */
        function hideConfirmModal() {
            confirmModal.classList.add('hidden');
            currentRowIndexToDelete = null;
        }

        /**
         * ดำเนินการลบข้อมูลจริง
         */
        confirmDeleteBtn.addEventListener('click', async () => {
            if (currentRowIndexToDelete) {
                hideConfirmModal();
                
                const result = await postData('delete', { RowIndex: currentRowIndexToDelete });

                if (result.success) {
                    // Reload filters and re-apply current filter
                    await loadUniqueFilters();
                    applyFilter();
                }
            }
        });


        // ====================================================================
        // --- Initialization ---
        // ====================================================================
        
        document.addEventListener('DOMContentLoaded', () => {
            loadUniqueFilters();
            
            // Set initial message
            tableMessage.textContent = 'กรุณาเลือก Model และ Part Name เพื่อแสดงข้อมูล';
            tableMessage.classList.remove('hidden');

            // Attach event listener for filter button
            applyFilterBtn.addEventListener('click', applyFilter);
        });

    </script>
</body>
</html>


