<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å‡πÄ‡∏õ‡πá‡∏ô Inter ‡∏´‡∏£‡∏∑‡∏≠‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sans-serif ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        /* Style for editable spans in header for better visibility */
        .editable-span {
            min-width: 100px; /* Ensures space when empty */
            display: inline-block;
            border-bottom: 2px dotted transparent;
            cursor: text;
        }
        .editable-span:focus {
            outline: none;
            border-bottom: 2px dotted #4f46e5;
        }
        /* Style for editable input fields inside the table */
        .editable-input {
            width: 100%;
            background-color: transparent;
            border: none;
            padding: 0;
            margin: 0;
            line-height: inherit;
            box-shadow: none;
            outline: none;
            transition: all 0.1s;
        }
        .editable-input:focus {
            background-color: #fffbeb; /* Light yellow background when focused */
            box-shadow: 0 0 0 1px #a78bfa inset;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">

        <!-- ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
        <h1 class="text-3xl font-bold text-gray-800 mb-0">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h1>
        <p class="text-sm text-gray-400 mb-2">Revision: v1.07</p>
        <p class="text-lg text-indigo-600 mb-6 border-b pb-4">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤, ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç, ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏• -->
        <div class="space-y-4 mb-8 p-4 border-2 border-dashed border-gray-300 rounded-lg bg-gray-50">
            <!-- File Input -->
            <input type="file" id="imageUpload" accept="image/*" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-full file:border-0
                file:text-sm file:font-semibold
                file:bg-indigo-50 file:text-indigo-700
                hover:file:bg-indigo-100" />
            
            <!-- Process Button -->
            <button id="processButton" onclick="handleUpload()" disabled
                class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed">
                ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
            </button>
            
        </div>

        <!-- Loading Indicator & Error Area -->
        <div id="loading" class="hidden text-center p-4 bg-yellow-100 rounded-lg text-yellow-700 font-medium mb-6">
            <p>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•... ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà (‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ 5-10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</p>
        </div>
        
        <div id="errorArea" class="hidden mb-6 p-4 bg-red-100 border border-red-300 rounded-lg text-red-700 font-medium">
            <p>‚ö†Ô∏è ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•</p>
            <p id="errorMessage" class="text-sm mt-1"></p>
        </div>
        
        <!-- Machine No. Selector -->
        <div class="mb-8 p-4 bg-purple-50 rounded-lg border border-purple-200 shadow-inner">
            <label for="machineNoSelect" class="block text-center font-bold text-lg text-purple-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine No.)</label>
            <select id="machineNoSelect" class="w-full p-3 border border-purple-300 rounded-lg shadow-sm focus:ring-purple-500 focus:border-purple-500 text-xl font-bold text-center">
                <option value="" disabled selected>-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Machine No. --</option>
                <option value="SC001">SC001</option>
                <option value="SC002">SC002</option>
                <option value="SC003">SC003</option>
                <option value="SC004">SC004</option>
                <option value="SC005">SC005</option>
                <option value="SC006">SC006</option>
                <option value="SC007">SC007</option>
                <option value="SC008">SC008</option>
                <option value="SC009">SC009</option>
                <option value="SC010">SC010</option>
                <option value="SC011">SC011</option>
                <option value="SC012">SC012</option>
                <option value="SC013">SC013</option>
                <option value="SC014">SC014</option>
                <option value="SC015">SC015</option>
                <option value="SC016">SC016</option>
            </select>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û (Editable using contenteditable) -->
        <div class="mb-8 bg-indigo-50 p-4 rounded-lg border border-indigo-200 shadow-inner">
            
            <!-- ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å Dropdown -->
            <div class="flex items-center justify-center space-x-6 mb-4">
                <label for="mainBoxSelect" class="text-xl font-bold text-red-700">‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å</label>
                <select id="mainBoxSelect" class="p-3 border-2 border-red-500 rounded-lg shadow-md focus:ring-red-500 focus:border-red-500 text-2xl font-extrabold text-center text-red-700">
                    <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                </select>
            </div>
            
            <div class="text-center">
                <p class="font-semibold text-sm text-gray-500 uppercase tracking-wider">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡πÑ‡∏î‡πâ</p>
                <span id="programName" contenteditable="true" class="editable-span block text-3xl font-extrabold text-gray-700">-- N/A --</span>
                <p class="text-base text-gray-600">
                    <span id="activePatternPNo" contenteditable="true" class="editable-span font-bold">-- N/A --</span> : 
                    <span id="pNoValue" contenteditable="true" class="editable-span">-- N/A --</span>
                </p>
            </div>
        </div>

        <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 2: ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ -->
        <div class="space-y-6">
            <h2 class="text-2xl font-semibold text-gray-700 border-b-2 pb-2">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏Å‡∏±‡∏î</h2>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å‡∏†‡∏≤‡∏û (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- ‡∏û‡∏¥‡∏Å‡∏±‡∏î X -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏û‡∏¥‡∏Å‡∏±‡∏î</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">‡∏û‡∏¥‡∏Å‡∏±‡∏î X</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="coordX" class="editable-input text-green-600 font-mono" value="X -- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏û‡∏¥‡∏Å‡∏±‡∏î Y -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏û‡∏¥‡∏Å‡∏±‡∏î</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">‡∏û‡∏¥‡∏Å‡∏±‡∏î Y</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="coordY" class="editable-input text-green-600 font-mono" value="Y -- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 1 -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ù‡∏µ‡πÄ‡∏Ç‡πá‡∏°</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="setting1" class="editable-input text-blue-600 font-mono" value="-- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 2 -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="setting2" class="editable-input text-blue-600 font-mono" value="-- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 3 -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="setting3" class="editable-input text-blue-600 font-mono" value="-- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 4 -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="setting4" class="editable-input text-blue-600 font-mono" value="-- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 5 -->
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">+X,-X</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="setting5" class="editable-input text-blue-600 font-mono" value="-- N/A --">
                            </td>
                        </tr>
                        <!-- ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ 6 -->
                        <tr class="bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap font-medium text-gray-900">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</td>
                            <td class="px-6 py-4 whitespace-nowrap text-gray-600">+Y,-Y</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <input type="text" id="setting6" class="editable-input text-blue-600 font-mono" value="-- N/A --">
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Active Pattern) -->
            <div class="mt-8">
                <h2 class="text-2xl font-semibold text-gray-700 border-b-2 pb-2 mb-4">‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Active Pattern)</h2>
                <div class="flex flex-wrap gap-3 p-4 bg-gray-100 rounded-lg justify-center">
                    <!-- ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô‡∏ó‡∏µ‡πà Active -->
                    <span id="activePatternDisplay" contenteditable="true" class="editable-span px-4 py-2 text-xl bg-gray-400 text-white font-bold rounded-lg shadow-xl border-4 border-gray-500">
                        -- N/A --
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Action Buttons (Save and Clear) moved to the bottom -->
        <div class="flex space-x-4 pt-6 mt-6 border-t border-gray-200">
            <button id="saveButton" onclick="handleSave()" disabled
                class="w-1/2 py-3 px-4 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v8a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-4 0V4m0 3h-4m4 0h4m-4 0v3m-4 0h4m-4 0h4"></path></svg>
                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Save)
            </button>
            <button id="clearButton" onclick="clearDataFields()" 
                class="w-1/2 py-3 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Clear)
            </button>
        </div>
        
        <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô -->
        <div class="mt-4 pt-4 border-t border-gray-200">
             <p class="text-sm text-gray-500">
                üí° **‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:** ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ö‡∏ö‡∏ö 
            </p>
            <p class="text-xs text-red-400 mt-1">
                (üö´ **‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Firebase Firestore ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡πâ‡∏ß)
            </p>
        </div>

    </div>
    
    <!-- Floating Toast Notification (Pop-up confirmation) -->
    <div id="toastNotification" class="fixed bottom-4 right-4 z-50 p-4 rounded-lg shadow-2xl transition-opacity duration-300 opacity-0 pointer-events-none text-white font-semibold transform translate-y-full">
        <p id="toastMessage"></p>
    </div>

    <!-- JavaScript Logic -->
    <script type="module">
        
        // ** (‡∏•‡∏ö Firebase Imports ‡∏≠‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î) **

        // ** ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ID ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° (‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Firebase) **
        let userId = crypto.randomUUID(); // ‡πÉ‡∏ä‡πâ UUID ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡πÅ‡∏ó‡∏ô
        let isAuthReady = false; 

        // *** GOOGLE SHEET CONFIGURATION ***
        // NOTE: ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô URL ‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô URL ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì Deploy Google Apps Script Web App ‡πÅ‡∏•‡πâ‡∏ß
        const SPREADSHEET_ID = '1-um_NqLwpGn2paJ6xHnnGiFK23SMhHeH4I-I_lbVaio'; 
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwqV-nBJaHDbaVOwWpZ5TnOKH3pgelbg4Z0oxvrc3SttbhwJZzq5ozirXWuuG1DOI9_/exec'; 

        // Initialize App and Readiness (‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà Firebase Initialization)
        function initializeAppAndAuth() {
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å
            userId = crypto.randomUUID(); 
            isAuthReady = true; 
            document.getElementById('processButton').disabled = false;
            console.log("App initialized. Using temporary user ID:", userId);
        }

        /** Converts a File object to a Base64 string */
        const convertFileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => {
                    // Extracting the Base64 data part
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
            });
        };
        
        // JSON Schema for structured output
        const outputSchema = {
            type: "OBJECT",
            properties: {
                programName: { type: "STRING", description: "The main program code, e.g., RG21 RBPU LEK2" },
                pNoValue: { type: "NUMBER", description: "The large number associated with the active pattern, e.g., 286" },
                coordX: { type: "STRING", description: "The X coordinate and scale, formatted as 'X 497.4 (100.0%)'" },
                coordY: { type: "STRING", description: "The Y coordinate and scale, formatted as 'Y 343.6 (100.0%)'" },
                setting1: { type: "NUMBER", description: "The first setting value, e.g., 258" },
                setting2: { type: "NUMBER", description: "The second setting value, e.g., 50" },
                setting3: { type: "NUMBER", description: "The third setting value, e.g., 800" },
                setting4: { type: "NUMBER", description: "The fourth setting value, e.g., 35" },
                setting5: { type: "NUMBER", description: "The fifth setting value, e.g., 0.0" },
                setting6: { type: "NUMBER", description: "The sixth setting value, e.g., 0.0" },
                activePattern: { type: "STRING", description: "The active pattern number, e.g., P25" }
            },
            required: ["programName", "pNoValue", "coordX", "coordY", "setting1", "setting2", "setting3", "setting4", "setting5", "setting6", "activePattern"]
        };


        /** Calls the Gemini API with exponential backoff */
        const callGeminiAPI = async (base64Image, mimeType, prompt, maxRetries = 5) => {
            // NOTE: **‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏ API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡∏ô‡∏≠‡∏Å Canvas**
            // ‡∏´‡∏≤‡∏Å‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ô‡πÉ‡∏ô Canvas, API Key ‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏´‡πâ‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
            const apiKey = "AIzaSyD4pDockyyUKft4kx6T4LCc5agKPmV7PNY"; 
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            // System prompt to guide the model's output structure
            const systemPrompt = "You are an expert data extraction assistant. Analyze the machine control panel image. Extract the main program name, the PNo value (the large number), the X and Y coordinate displays (including scale), the six major numerical setting values (258, 50, 800, 35, 0.0, 0.0), and the active pattern name (e.g., P25). Respond strictly in the required JSON format.";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: prompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: outputSchema
                }
            };

            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429 && i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000; // Exponential backoff
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue; // Retry
                    }

                    if (!response.ok) {
                        const errorBody = await response.json();
                        let errorMessage = `API failed with status ${response.status}: ${errorBody.error?.message || 'Unknown error'}`;
                        if (response.status === 403) {
                             errorMessage += " (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ API Key ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Gemini API ‡πÅ‡∏•‡πâ‡∏ß)";
                        }
                        throw new Error(errorMessage);
                    }

                    const result = await response.json();
                    const jsonString = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (!jsonString) {
                         throw new Error("API response was empty or malformed.");
                    }
                    
                    return JSON.parse(jsonString);

                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                }
            }
        };

        // --- Toast Handler (The "Pop-up" message) ---
        const showToast = (message, type) => {
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            
            // Set colors based on type
            toast.classList.remove('bg-green-600', 'bg-red-600', 'bg-blue-600');
            if (type === 'success') {
                toast.classList.add('bg-green-600');
            } else if (type === 'error') {
                toast.classList.add('bg-red-600');
            } else { // info/loading
                toast.classList.add('bg-blue-600');
            }

            // Show toast (slide up and fade in)
            toast.classList.remove('opacity-0', 'pointer-events-none', 'translate-y-full');
            toast.classList.add('opacity-100', 'translate-y-0');

            // Hide toast after 4 seconds for success/error
            if (type !== 'info') {
                 setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'pointer-events-none', 'translate-y-full');
                }, 4000);
            }
        };

        // --- Data Uploader ---
        window.handleUpload = async () => {
            const fileInput = document.getElementById('imageUpload');
            const file = fileInput.files[0];
            const loadingIndicator = document.getElementById('loading');
            const errorArea = document.getElementById('errorArea');
            const processButton = document.getElementById('processButton');
            
            // Re-check readiness just in case (though button should be disabled if not ready)
            if (!isAuthReady) {
                 showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà', 'error');
                 return;
            }
            
            if (!file) {
                showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô', 'error');
                return;
            }
            
            loadingIndicator.classList.remove('hidden');
            errorArea.classList.add('hidden');
            processButton.disabled = true;

            try {
                const base64Image = await convertFileToBase64(file);
                
                const prompt = "Extract all numerical values and text displays from the machine control panel screen into the required JSON structure. Pay close attention to the PNo value and the X/Y coordinates.";

                const extractedData = await callGeminiAPI(base64Image, file.type, prompt);
                
                renderDataToTable(extractedData);
                showToast('‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'success');
                
            } catch (error) {
                console.error("Image Processing Error:", error);
                document.getElementById('errorMessage').textContent = error.message;
                errorArea.classList.remove('hidden');
                document.getElementById('saveButton').disabled = true;
                showToast('‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (‡∏î‡∏π Console ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î)', 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                processButton.disabled = false;
            }
        }
        
        // --- Data Renderer ---
        const renderDataToTable = (data) => {
            // Update Main Header Block (contenteditable spans use textContent)
            document.getElementById('programName').textContent = data.programName || '-- N/A --';
            document.getElementById('activePatternPNo').textContent = data.activePattern || '-- N/A --';
            document.getElementById('pNoValue').textContent = data.pNoValue !== undefined ? data.pNoValue : '-- N/A --';

            // Update Table Data (input fields use value)
            document.getElementById('coordX').value = data.coordX || 'X -- N/A --';
            document.getElementById('coordY').value = data.coordY || 'Y -- N/A --';
            document.getElementById('setting1').value = data.setting1 !== undefined ? String(data.setting1) : '-- N/A --';
            document.getElementById('setting2').value = data.setting2 !== undefined ? String(data.setting2) : '-- N/A --';
            document.getElementById('setting3').value = data.setting3 !== undefined ? String(data.setting3) : '-- N/A --';
            document.getElementById('setting4').value = data.setting4 !== undefined ? String(data.setting4) : '-- N/A --';
            document.getElementById('setting5').value = data.setting5 !== undefined ? String(data.setting5) : '-- N/A --';
            document.getElementById('setting6').value = data.setting6 !== undefined ? String(data.setting6) : '-- N/A --';
            
            // Update Active Pattern Display (contenteditable span uses textContent)
            const activePatternDisplay = document.getElementById('activePatternDisplay');
            activePatternDisplay.textContent = data.activePattern ? `${data.activePattern} (Active)` : '-- N/A --';
            
            // Update styling based on data availability
            if (data.activePattern) {
                activePatternDisplay.classList.remove('bg-gray-400', 'border-gray-500');
                activePatternDisplay.classList.add('bg-green-500', 'border-green-700');
            } else {
                activePatternDisplay.classList.add('bg-gray-400', 'border-gray-500');
                activePatternDisplay.classList.remove('bg-green-500', 'border-green-700');
            }

            // Enable Save button after successful rendering 
            document.getElementById('saveButton').disabled = false;
        };

        // --- Data Clearer ---
        window.clearDataFields = () => {
            // Clear Machine No. dropdown
            document.getElementById('machineNoSelect').value = ""; 
            // Clear Main Box dropdown
            document.getElementById('mainBoxSelect').value = "";

            // Clear spans (contenteditable)
            document.getElementById('programName').textContent = '-- N/A --';
            document.getElementById('activePatternPNo').textContent = '-- N/A --';
            document.getElementById('pNoValue').textContent = '-- N/A --';

            // Clear inputs (value)
            document.getElementById('coordX').value = 'X -- N/A --';
            document.getElementById('coordY').value = 'Y -- N/A --';
            document.getElementById('setting1').value = '-- N/A --';
            document.getElementById('setting2').value = '-- N/A --';
            document.getElementById('setting3').value = '-- N/A --';
            document.getElementById('setting4').value = '-- N/A --';
            document.getElementById('setting5').value = '-- N/A --';
            document.getElementById('setting6').value = '-- N/A --';
            
            // Clear active pattern display and styling
            const activePatternDisplay = document.getElementById('activePatternDisplay');
            activePatternDisplay.textContent = '-- N/A --';
            activePatternDisplay.classList.add('bg-gray-400', 'border-gray-500');
            activePatternDisplay.classList.remove('bg-green-500', 'border-green-700');

            // Disable Save button
            document.getElementById('saveButton').disabled = true;
            
            // Show toast
            showToast('üóëÔ∏è ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'info');
        }

        // --- Data Collector ---
        const collectCurrentData = () => {
            // Collect data from Machine No. dropdown and other fields
            const data = {
                timestamp: new Date().toISOString(),
                userId: userId, // ‡πÉ‡∏ä‡πâ UUID ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô
                machineNo: document.getElementById('machineNoSelect').value.trim(), 
                // NEW FIELD: ‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å
                mainBox: document.getElementById('mainBoxSelect').value.trim(), 
                programName: document.getElementById('programName').textContent.trim(),
                activePatternPNo: document.getElementById('activePatternPNo').textContent.trim(),
                pNoValue: document.getElementById('pNoValue').textContent.trim(),
                coordX: document.getElementById('coordX').value.trim(),
                coordY: document.getElementById('coordY').value.trim(),
                setting1: document.getElementById('setting1').value.trim(),
                setting2: document.getElementById('setting2').value.trim(),
                setting3: document.getElementById('setting3').value.trim(),
                setting4: document.getElementById('setting4').value.trim(),
                setting5: document.getElementById('setting5').value.trim(),
                setting6: document.getElementById('setting6').value.trim(),
                activePatternDisplay: document.getElementById('activePatternDisplay').textContent.trim()
            };
            return data;
        }

        /**
         * Sends data to the deployed Google Apps Script Web App.
         * @param {object} data - The data object to send.
         * @returns {Promise<boolean>} - True if successful, false otherwise.
         */
        const sendDataToGoogleSheet = async (data) => {
            const payload = { 
                ...data, 
                spreadsheetId: SPREADSHEET_ID 
            };
            
            try {
                // NOTE: ‡πÉ‡∏ä‡πâ 'no-cors' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î CORS ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script ‡∏à‡∏≤‡∏Å‡πÇ‡∏î‡πÄ‡∏°‡∏ô‡∏≠‡∏∑‡πà‡∏ô
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    referrerPolicy: 'no-referrer', 
                    body: JSON.stringify(payload)
                });
                
                // ‡πÉ‡∏ô‡πÇ‡∏´‡∏°‡∏î 'no-cors' ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô response.ok ‡∏´‡∏£‡∏∑‡∏≠ body ‡πÑ‡∏î‡πâ
                // ‡∏à‡∏∂‡∏á‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ TypeError (‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/CORS) 
                console.log("Sheet fetch sent with mode: 'no-cors'. Assuming success if no TypeError is thrown.");
                return true;

            } catch (error) {
                // ‡∏´‡∏≤‡∏Å fetch ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢/CORS
                console.error("Google Sheet Save Error (Likely Network/CORS Block):", error);
                showToast(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Sheet ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message} (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö APPS_SCRIPT_URL ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Web App)`, 'error'); 
                return false;
            }
        }

        // --- Data Saver (ONLY Google Sheet) ---
        window.handleSave = async () => {
            const data = collectCurrentData();
            const saveButton = document.getElementById('saveButton');
            
            // CRITICAL CHECK: Check readiness
            if (!isAuthReady) {
                showToast('‚ö†Ô∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                console.error("Save failed: App is not ready.");
                saveButton.disabled = false;
                return;
            }

            // Check if machine number is selected
            if (data.machineNo === "") {
                 showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (Machine No.) ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                 return;
            }
            
            // Check if main box number is selected
            if (data.mainBox === "") {
                 showToast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
                 return;
            }
            
            saveButton.disabled = true;
            
            // Show "saving" status using the toast
            showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 'info'); 

            let sheetSuccess = false;

            try {
                
                // 1. SAVE TO GOOGLE SHEET
                sheetSuccess = await sendDataToGoogleSheet(data);
                
                // Final confirmation
                if (sheetSuccess) {
                    showToast(`‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Google Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢)`, 'success');
                } else {
                    // ‡∏´‡∏≤‡∏Å‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö no-cors ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                    throw new Error("Save failed completely. Google Sheet was not successful or encountered a network error.");
                }
                
            } catch (error) {
                console.error("General Save Error:", error);
                showToast(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`, 'error');
            } finally {
                // Ensure toast is cleared/reset if it was the 'info' saving toast
                if (document.getElementById('toastNotification').classList.contains('bg-blue-600')) {
                    document.getElementById('toastNotification').classList.remove('opacity-100', 'translate-y-0');
                    document.getElementById('toastNotification').classList.add('opacity-0', 'pointer-events-none', 'translate-y-full');
                }
                saveButton.disabled = false;
            }
        };

        // Enable button when file is selected
        document.getElementById('imageUpload').addEventListener('change', (e) => {
            const processButton = document.getElementById('processButton');
            // Only enable if app is ready AND a file is selected
            processButton.disabled = e.target.files.length === 0 || !isAuthReady; 
            if (e.target.files.length > 0) {
                 document.getElementById('errorArea').classList.add('hidden');
            }
        });
        
        // Start initialization
        initializeAppAndAuth();
    </script>

</body>
</html>
