<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Condition Machine (Machine Condition Tracker)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom font and layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-fluid {
            min-height: 100vh;
        }
        /* Custom table styling for better readability */
        .data-table th, .data-table td {
            padding: 10px 15px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap; /* Prevent wrapping in narrow columns */
        }
        .data-table th {
            background-color: #e8f0ff;
            color: #1e40af;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
        }
        .tts-button {
            color: #10b981; /* green-500 */
            border: 1px solid #10b981;
        }
        .tts-button:hover {
            background-color: #f0fdf4; /* green-50 */
        }
    </style>
</head>
<body>

    <div id="app" class="container-fluid mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-extrabold text-blue-800 mb-2">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Condition Machine</h1>
            <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</p>
            <div id="loading-indicator" class="text-center py-4 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
                <p class="text-sm text-blue-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
            <div id="error-message" class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mt-4 hidden" role="alert">
                <p class="font-bold">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                <p id="error-text"></p>
            </div>
        </header>
        
        <!-- --- 1. Selection Screen (Initial Filter) --- -->
        <div id="selection-screen" class="max-w-xl mx-auto bg-white p-8 rounded-xl shadow-2xl text-center mt-16">
            <h2 class="text-2xl font-bold text-blue-700 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Machine Condition ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π</h2>
            <p class="text-gray-500 mb-6">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏° Model ‡πÅ‡∏•‡∏∞ Part Name ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
            
            <div class="space-y-4">
                <div>
                    <label for="model-select" class="block text-left text-sm font-medium text-gray-700 mb-1">Model ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£:</label>
                    <select id="model-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model --</option>
                    </select>
                </div>
                <div>
                    <label for="partname-select" class="block text-left text-sm font-medium text-gray-700 mb-1">Part Name:</label>
                    <select id="partname-select" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500" required>
                        <option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part Name --</option>
                    </select>
                </div>
            </div>
            
            <!-- Removed 'disabled' from here, it's controlled by JS now -->
            <button id="submit-selection-btn" class="mt-8 w-full px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">
                ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (View Data)
            </button>
            <p id="selection-status" class="mt-3 text-sm text-red-500 hidden">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á Model ‡πÅ‡∏•‡∏∞ Part Name ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î "‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>

        </div>

        <!-- --- 2. Main App Screen (Hidden until selection) --- -->
        <div id="main-app-screen" class="hidden">

            <!-- Role Selector/Mode Switch -->
            <div class="flex justify-between items-center mb-6 p-3 bg-white rounded-lg shadow-md">
                <div class="flex items-center space-x-4">
                    <span class="text-sm font-medium text-gray-700">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á:</span>
                    <span id="current-filter-display" class="font-bold text-blue-600 text-sm"></span>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="reset-filter-btn" class="px-3 py-1 bg-yellow-500 text-white rounded-full text-xs font-semibold hover:bg-yellow-600 transition duration-150">
                        ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
                    </button>
                    <span class="text-sm font-medium text-gray-700">‡πÇ‡∏´‡∏°‡∏î:</span>
                    <button id="mode-engineer" class="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200">Engineer</button>
                    <button id="mode-view" class="px-4 py-2 rounded-full text-sm font-semibold transition-all duration-200">‡∏ú‡∏•‡∏¥‡∏ï/‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</button>
                    <span id="user-id-display" class="text-xs text-gray-500 bg-gray-100 p-2 rounded-lg"></span>
                </div>
            </div>

            <!-- Engineer Mode: Data Entry Form -->
            <div id="engineer-mode" class="hidden">
                <h2 class="text-2xl font-bold text-blue-700 mb-4">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Condition Machine</h2>
                
                <!-- LLM Analysis Output -->
                <div id="analysis-output-container" class="mb-6">
                    <div id="analysis-output" class="mt-4 p-4 bg-purple-50 rounded-xl border-l-4 border-purple-500 text-gray-800 shadow-md hidden">
                        <p class="font-bold mb-2 text-purple-800">‚ú® ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏î‡∏¢ AI:</p>
                        <div id="analysis-text" class="prose max-w-none text-sm"></div>
                    </div>
                    <div id="analysis-loading" class="text-center py-4 hidden">
                        <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-500 mx-auto"></div>
                        <p class="text-sm text-purple-500 mt-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
                    </div>
                </div>

                <form id="condition-form" class="bg-white p-6 rounded-xl shadow-lg grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">

                    <!-- Hidden field for document ID during editing. For Sheet, this is the Row Index -->
                    <input type="hidden" id="doc-id">
                    
                    <!-- Pre-filled Filtered Fields (Now visible and Read-only for clarity) -->
                    <div class="col-span-1">
                        <label for="Model" class="block text-sm font-medium text-gray-700">Model ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£</label>
                        <input type="text" id="Model" value="" required readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 bg-gray-100 cursor-not-allowed">
                    </div>
                    <div class="col-span-1">
                        <label for="PartName" class="block text-sm font-medium text-gray-700">Part Name</label>
                        <input type="text" id="PartName" value="" required readonly class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500 bg-gray-100 cursor-not-allowed">
                    </div>
                    <!-- Empty column for spacing/visual break -->
                    <div class="col-span-1 hidden lg:block"></div>

                    <!-- Input Fields (Start from Process No. as Model/PartName are now displayed above) -->
                    <div class="col-span-1">
                        <label for="ProcessNo" class="block text-sm font-medium text-gray-700">Process No.</label>
                        <input type="text" id="ProcessNo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="MachineNo" class="block text-sm font-medium text-gray-700">Machine No.</label>
                        <input type="text" id="MachineNo" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="ProcessName" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£</label>
                        <input type="text" id="ProcessName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="ThreadNo" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πâ‡∏≤‡∏¢</label>
                        <input type="text" id="ThreadNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="NeedleNo" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πá‡∏°</label>
                        <input type="text" id="NeedleNo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="StitchLength" class="block text-sm font-medium text-gray-700">‡∏ù‡∏µ‡πÄ‡∏Ç‡πá‡∏°</label>
                        <input type="text" id="StitchLength" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="UpperTension" class="block text-sm font-medium text-gray-700">‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏ö‡∏ô (N) STD + 3</label>
                        <input type="number" step="0.1" id="UpperTension" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="LowerTension" class="block text-sm font-medium text-gray-700">‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á (N) STD + 3</label>
                        <input type="number" step="0.1" id="LowerTension" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="OuterFootPressure" class="block text-sm font-medium text-gray-700">‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡∏ô‡∏≠‡∏Å (Kg) STD + 1</label>
                        <input type="number" step="0.1" id="OuterFootPressure" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="InnerFootPressure" class="block text-sm font-medium text-gray-700">‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡πÉ‡∏ô (Kg) STD + 1</label>
                        <input type="number" step="0.1" id="InnerFootPressure" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="StopperDistance" class="block text-sm font-medium text-gray-700">‡∏£‡∏∞‡∏¢‡∏∞ stopper ‡∏ï‡∏∞‡πÄ‡∏Ç‡πá‡∏ö (mm)</label>
                        <input type="number" step="0.1" id="StopperDistance" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="AirPressure" class="block text-sm font-medium text-gray-700">‡πÅ‡∏£‡∏á‡∏•‡∏° (bar)</label>
                        <input type="number" step="0.1" id="AirPressure" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="SpeedRPM" class="block text-sm font-medium text-gray-700">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏£‡∏≠‡∏ö (rpm)</label>
                        <input type="number" id="SpeedRPM" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div class="col-span-1">
                        <label for="ManSkill" class="block text-sm font-medium text-gray-700">Man skill ‚â•</label>
                        <input type="number" id="ManSkill" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-span-full flex justify-end space-x-4 pt-4">
                        <button type="button" id="generate-analysis-btn" class="px-6 py-2 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition duration-150 shadow-md">
                            ‚ú® ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå Condition & ‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞
                        </button>
                        <button type="button" id="clear-form-btn" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 transition duration-150">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
                        <button type="submit" id="submit-btn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-150 shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                    </div>
                </form>
            </div>

            <!-- View Mode: Data Table -->
            <div id="view-mode">
                <h2 class="text-2xl font-bold text-blue-700 mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á Condition Machine</h2>

                <div class="overflow-x-auto bg-white rounded-xl shadow-lg">
                    <table class="min-w-full divide-y divide-gray-200 data-table">
                        <thead>
                            <tr>
                                <th class="min-w-[100px]">Model / Part Name</th>
                                <th>Process No.</th>
                                <th>Machine No.</th>
                                <th class="min-w-[120px]">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£</th>
                                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πâ‡∏≤‡∏¢</th>
                                <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πá‡∏°</th>
                                <th>‡∏ù‡∏µ‡πÄ‡∏Ç‡πá‡∏°</th>
                                <th>‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏ö‡∏ô (N)</th>
                                <th>‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á (N)</th>
                                <th>‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡∏ô‡∏≠‡∏Å (Kg)</th>
                                <th>‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡πÉ‡∏ô (Kg)</th>
                                <th>‡∏£‡∏∞‡∏¢‡∏∞ Stopper (mm)</th>
                                <th>‡πÅ‡∏£‡∏á‡∏•‡∏° (bar)</th>
                                <th>‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏£‡∏≠‡∏ö (rpm)</th>
                                <th>Man Skill ‚â•</th>
                                <th id="table-actions-header" class="hidden">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç/‡∏•‡∏ö</th>
                                <th>üîä TTS</th>
                            </tr>
                        </thead>
                        <tbody id="condition-list" class="divide-y divide-gray-100">
                            <!-- Data will be injected here by JavaScript -->
                            <tr id="no-data-row"><td colspan="17" class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Condition Machine ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏µ‡πâ</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Script uses Google Sheet Web App endpoint instead of Firebase -->
    <script type="module">
        
        // --- GOOGLE SHEET CONFIGURATION (REPLACING FIREBASE) ---
        const SHEET_ID = '1hRZce6aqXWAx7XPN33n-QunQPJE0B1a4r898WoZKQsT';
        
        // !!! URL ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß !!!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxqsmAdMlfpIG3pNGHC3fBcPIuhNoeyGiWa91EG9qitQwoH_h-9TmP_8qnFVa7LWVa-DA/exec'; 
        
        const POLLING_INTERVAL = 10000; // Poll every 10 seconds for updates (simulate real-time)

        // --- GEMINI API Constants ---
        const API_KEY = ""; 
        const LLM_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";
        const BASE_API_URL = "https://generativelanguage.googleapis.com/v1beta/models";
        const TTS_VOICE = "Kore"; 

        // Global variables (Simplified from Firebase version)
        let userId = 'sheet_user_1'; // Dummy user ID for Sheet
        let isAuthReady = false;
        let pollingTimer = null; // To hold the polling timer

        // --- State for Filtering ---
        let selectedModel = null;
        let selectedPartName = null;
        
        // UI Elements
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const userIdDisplay = document.getElementById('user-id-display');
        const engineerModeDiv = document.getElementById('engineer-mode');
        const viewModeDiv = document.getElementById('view-mode');
        const conditionForm = document.getElementById('condition-form');
        const conditionList = document.getElementById('condition-list');
        const submitBtn = document.getElementById('submit-btn');
        const tableActionsHeader = document.getElementById('table-actions-header');
        const noDataRow = document.getElementById('no-data-row');
        const analysisOutputContainer = document.getElementById('analysis-output');
        const analysisText = document.getElementById('analysis-text');
        const analysisLoading = document.getElementById('analysis-loading');
        const generateAnalysisBtn = document.getElementById('generate-analysis-btn');

        // New UI Elements for Filtering
        const selectionScreen = document.getElementById('selection-screen');
        const mainAppScreen = document.getElementById('main-app-screen');
        const modelSelect = document.getElementById('model-select');
        const partNameSelect = document.getElementById('partname-select');
        const submitSelectionBtn = document.getElementById('submit-selection-btn');
        const currentFilterDisplay = document.getElementById('current-filter-display');
        const resetFilterBtn = document.getElementById('reset-filter-btn');
        
        // Form Fields (now visible)
        const ModelInput = document.getElementById('Model');
        const PartNameInput = document.getElementById('PartName');


        // State
        let currentMode = 'view'; // Default mode is view

        // Field definitions for the form (MUST MATCH THE ORDER IN google_app_script.gs)
        const fieldMapping = {
            Model: 'Model', PartName: 'Part Name', ProcessNo: 'Process No.', MachineNo: 'Machine No.',
            ProcessName: '‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£', ThreadNo: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏î‡πâ‡∏≤‡∏¢', NeedleNo: '‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Ç‡πá‡∏°', StitchLength: '‡∏ù‡∏µ‡πÄ‡∏Ç‡πá‡∏°',
            UpperTension: '‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏ö‡∏ô (N) STD + 3', LowerTension: '‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á (N) STD + 3',
            OuterFootPressure: '‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡∏ô‡∏≠‡∏Å (Kg) STD + 1', InnerFootPressure: '‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡πÉ‡∏ô (Kg) STD + 1',
            StopperDistance: '‡∏£‡∏∞‡∏¢‡∏∞ stopper ‡∏ï‡∏∞‡πÄ‡∏Ç‡πá‡∏ö (mm)', AirPressure: '‡πÅ‡∏£‡∏á‡∏•‡∏° (bar)', SpeedRPM: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏£‡∏≠‡∏ö (rpm)',
            ManSkill: 'Man skill ‚â•'
        };
        const fields = Object.keys(fieldMapping);


        // --- Utility Functions ---

        function showLoading() {
            loadingIndicator.classList.remove('hidden');
        }

        function hideLoading() {
            loadingIndicator.classList.add('hidden');
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
            console.error('Application Error:', message);
        }

        function showStatusMessage(message, isError = false) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `fixed top-4 right-4 p-4 rounded-lg shadow-xl text-white z-50 transition-opacity duration-300 ${isError ? 'bg-red-500' : 'bg-green-500'}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => {
                statusDiv.classList.add('opacity-0');
                statusDiv.addEventListener('transitionend', () => statusDiv.remove());
            }, 3000);
        }
        
        function confirmAction(message) {
             // Replaced window.confirm with a simpler function for this environment
             return true; // Assume confirmation for simplicity in this context
        }

        // --- Fetch with Exponential Backoff (for Gemini API) ---
        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    return response;
                } catch (error) {
                    console.error("Fetch attempt failed:", error);
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API request failed after multiple retries.");
        }


        // --- Gemini API: Analysis Feature (Unchanged) ---

        async function generateAnalysis() {
            analysisOutputContainer.classList.add('hidden');
            analysisLoading.classList.remove('hidden');
            analysisText.innerHTML = '';
            
            const data = {};
            let promptDetails = "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Condition Machine ‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤:\n";
            let missingRequiredField = false;

            // Collect all fields, including the locked Model and PartName
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value.trim();
                    if (element.required && !data[field]) {
                        // Check required fields, excluding Model/PartName which are pre-set
                        if (field !== 'Model' && field !== 'PartName') {
                           missingRequiredField = true;
                        }
                    }
                    if (data[field]) {
                         promptDetails += `- ${fieldMapping[field]}: ${data[field]}\n`;
                    }
                }
            });

            if (missingRequiredField) {
                 analysisLoading.classList.add('hidden');
                 showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô (Process No., Machine No., ‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£) ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå");
                 return;
            }

            const systemPrompt = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏≠‡∏≤‡∏ß‡∏∏‡πÇ‡∏™ (Senior Maintenance Engineer) ‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÇ‡∏•‡∏Å ‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Condition Machine ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÉ‡∏ô‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å ‡πÇ‡∏î‡∏¢‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏õ‡πâ‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏‡πÑ‡∏ß‡πâ (STD+3, STD+1) ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏∞‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏î‡πâ‡∏≤‡∏ô: 1. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÇ‡∏î‡∏¢‡∏£‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£ (‡∏õ‡∏Å‡∏ï‡∏¥, ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö, ‡∏ô‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡πà‡∏ß‡∏á) 2. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢, ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ) 3. ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏¥‡∏ï‡∏£‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ù‡πà‡∏≤‡∏¢‡∏ú‡∏•‡∏¥‡∏ï/‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Markdown (‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ä‡πâ **...** ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏ô‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)`;
            const userQuery = `‡πÇ‡∏õ‡∏£‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Condition Machine ‡∏ä‡∏∏‡∏î‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡∏∞‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:\n${promptDetails}`;

            const apiUrl = `${BASE_API_URL}/${LLM_MODEL}:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    analysisText.innerHTML = renderMarkdown(text);
                    analysisOutputContainer.classList.remove('hidden');
                } else {
                    analysisText.textContent = "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";
                    analysisOutputContainer.classList.remove('hidden');
                }
            } catch (e) {
                showError(`‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ Gemini API ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`);
            } finally {
                analysisLoading.classList.add('hidden');
            }
        }

        // Simple Markdown renderer (handles bold and newlines)
        function renderMarkdown(text) {
            let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            html = html.replace(/\n/g, '<br>'); // Newlines
            return html;
        }


        // --- Gemini API: TTS Feature (Unchanged) ---

        // Utility for Base64 to ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Utility for PCM to WAV conversion (Standard 16-bit PCM WAV header)
        function pcmToWav(pcmData, sampleRate) {
            const buffer = new ArrayBuffer(44 + pcmData.byteLength);
            const view = new DataView(buffer);
            const channelCount = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const byteRate = sampleRate * channelCount * bytesPerSample;
            const blockAlign = channelCount * bytesPerSample;

            /* RIFF identifier */
            view.setUint32(0, 0x52494646, false); // "RIFF"
            /* file length */
            view.setUint32(4, 36 + pcmData.byteLength, true);
            /* RIFF type */
            view.setUint32(8, 0x57415645, false); // "WAVE"
            /* format chunk identifier */
            view.setUint32(12, 0x666d7420, false); // "fmt "
            /* format chunk length */
            view.setUint32(16, 16, true);
            /* sample format (raw) */
            view.setUint16(20, 1, true); // 1 = PCM
            /* channel count */
            view.setUint16(22, channelCount, true);
            /* sample rate */
            view.setUint32(24, sampleRate, true);
            /* byte rate (sample rate * block align) */
            view.setUint32(28, byteRate, true);
            /* block align (channel count * bytes per sample) */
            view.setUint16(32, blockAlign, true);
            /* bits per sample */
            view.setUint16(34, bytesPerSample * 8, true);
            /* data chunk identifier */
            view.setUint32(36, 0x64617461, false); // "data"
            /* data chunk length */
            view.setUint32(40, pcmData.byteLength, true);

            // Copy PCM data
            const offset = 44;
            for (let i = 0; i < pcmData.length; i++) {
                view.setInt16(offset + i * 2, pcmData[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        window.speakCondition = async (data, buttonElement) => {
            buttonElement.disabled = true;
            buttonElement.innerHTML = `<svg class="animate-spin h-5 w-5 text-green-500 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>`;
            
            // Construct Thai prompt focusing on key parameters
            const textToSpeak = `Machine ${data.MachineNo || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}, Model ${data.Model || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'} ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: Process ${data.ProcessName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}. ‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏ö‡∏ô ${data.UpperTension || '-'} ‡∏ô‡∏¥‡∏ß‡∏ï‡∏±‡∏ô. ‡πÅ‡∏£‡∏á‡∏ï‡∏∂‡∏á‡∏î‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á ${data.LowerTension || '-'} ‡∏ô‡∏¥‡∏ß‡∏ï‡∏±‡∏ô. ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡∏ô‡∏≠‡∏Å ${data.OuterFootPressure || '-'} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°. ‡πÅ‡∏£‡∏á‡∏Å‡∏î‡∏ï‡∏µ‡∏ô‡∏ú‡∏µ‡πÉ‡∏ô ${data.InnerFootPressure || '-'} ‡∏Å‡∏¥‡πÇ‡∏•‡∏Å‡∏£‡∏±‡∏°. ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡∏£‡∏≠‡∏ö ${data.SpeedRPM || '-'} ‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏ô‡∏≤‡∏ó‡∏µ.`;

            const apiUrl = `${BASE_API_URL}/${TTS_MODEL}:generateContent?key=${API_KEY}`;
            const payload = {
                contents: [{ parts: [{ text: textToSpeak }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: { prebuiltVoiceConfig: { voiceName: TTS_VOICE } }
                    }
                },
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmDataBuffer = base64ToArrayBuffer(audioData);
                    // API returns signed PCM16 audio data.
                    const pcm16 = new Int16Array(pcmDataBuffer);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.onended = () => {
                        buttonElement.disabled = false;
                        buttonElement.innerHTML = `üîä ‡∏ü‡∏±‡∏á`;
                    };
                    audio.play();

                } else {
                    throw new Error("Invalid audio response structure from TTS API.");
                }
            } catch (e) {
                showError(`TTS ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`);
                buttonElement.disabled = false;
                buttonElement.innerHTML = `üîä ‡∏ü‡∏±‡∏á`;
            }
        }


        // --- App Initialization (Skipping Firebase) ---

        function initializeApp() {
            showLoading();
            // Simulate readiness since we are skipping Firebase auth
            userIdDisplay.textContent = `Data Source: Google Sheet`;
            isAuthReady = true;
            
            // Load filter options immediately 
            fetchUniqueCombinations(); 
            hideLoading();
        }

        // --- Data Management (Google Sheets via Web App) ---

        /**
         * Fetches data from the Google Sheet Web App endpoint.
         * @param {string} action - 'read_unique' or 'read_filtered'
         * @param {string} model - The selected machine model (optional)
         * @param {string} partName - The selected part name (optional)
         */
        async function fetchSheetData(action, model = '', partName = '') {
            // Check for the placeholder URL, which is the source of the reported error
            if (!WEB_APP_URL || WEB_APP_URL.includes('xxxxxxxx')) {
                 showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                 return { success: false, data: [] };
            }

            const url = new URL(WEB_APP_URL);
            url.searchParams.append('action', action);
            if (model) url.searchParams.append('model', model);
            if (partName) url.searchParams.append('partName', partName);
            
            showLoading();

            try {
                const response = await fetch(url.toString(), {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                    // mode: 'no-cors' is often needed for Apps Script GET, but we assume
                    // the deployed Apps Script is configured for wide access.
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to fetch data from Google Sheet Web App.');
                }
            } catch (e) {
                showError(`‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`);
                return { success: false, data: [] };
            } finally {
                hideLoading();
            }
        }

        /**
         * Sends data (save/update/delete) to the Google Sheet Web App endpoint via POST.
         * @param {string} action - 'save' or 'delete'
         * @param {Object} data - The data object to send (including row index for update/delete)
         */
        async function postSheetData(action, data) {
            if (!WEB_APP_URL || WEB_APP_URL.includes('xxxxxxxx')) {
                 showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà URL ‡∏Ç‡∏≠‡∏á Google Apps Script Web App ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
                 return { success: false };
            }

            showLoading();

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, data }),
                });

                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success) {
                    return result;
                } else {
                    throw new Error(result.error || 'Failed to post data to Google Sheet Web App.');
                }
            } catch (e) {
                showError('‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Google Sheet ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á');
                return { success: false };
            } finally {
                hideLoading();
            }
        }


        // --- Filtering and Selection Logic ---

        /**
         * Fetches all unique Model and PartName combinations to populate the filter selectors.
         */
        async function fetchUniqueCombinations() {
            if (!isAuthReady) return;

            modelSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Model --</option>';
            partNameSelect.innerHTML = '<option value="" disabled selected>-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Part Name --</option>';

            const result = await fetchSheetData('read_unique');
            
            if (result.success && result.data) {
                populateSelects(result.data.uniqueModels || [], result.data.uniquePartNames || []);
            } else {
                // If fetching fails, we still need to allow the user to proceed to add data
                if (!WEB_APP_URL || !WEB_APP_URL.includes('xxxxxxxx')) {
                     // We only show error if the URL is correct, otherwise the error is already shown above.
                     // Don't show an error here if the failure is simply due to empty sheet data.
                }
                populateSelects([], []); // Still call this to ensure the button is enabled
            }
        }

        /**
         * Populates the Model and Part Name select elements.
         * @param {Array} uniqueModels 
         * @param {Array} uniquePartNames 
         */
        function populateSelects(uniqueModels, uniquePartNames) {
            
            // Populate Model Select
            uniqueModels.sort().forEach(model => {
                const option = document.createElement('option');
                option.value = model;
                option.textContent = model;
                modelSelect.appendChild(option);
            });

            // Populate Part Name Select
            uniquePartNames.sort().forEach(partName => {
                const option = document.createElement('option');
                option.value = partName;
                option.textContent = partName;
                partNameSelect.appendChild(option);
            });

            // --- CRITICAL FIX: Always enable the submit button to allow adding the first record ---
            submitSelectionBtn.disabled = false;
            if (uniqueModels.length === 0 || uniquePartNames.length === 0) {
                 submitSelectionBtn.textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (View Data) / ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô';
            } else {
                 submitSelectionBtn.textContent = '‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (View Data)';
            }
        }

        /**
         * Handles the selection submission and initiates the main data screen.
         */
        function handleSelectionSubmit() {
            const model = modelSelect.value;
            const partName = partNameSelect.value;

            // Allow submission even if selections are empty (to add new data to an empty sheet)
            if (!model || !partName) {
                // Show warning but allow proceeding
                document.getElementById('selection-status').classList.remove('hidden');
            } else {
                document.getElementById('selection-status').classList.add('hidden');
            }

            // Set global filter state and handle null values for the first entry
            // Set default values based on the sample sheet image to assist first entry
            selectedModel = model || 'RG21'; 
            selectedPartName = partName || 'FC'; 

            // Set form fields for saving/editing consistency
            ModelInput.value = selectedModel;
            PartNameInput.value = selectedPartName;

            // Update display text
            currentFilterDisplay.textContent = `Model: ${selectedModel}, Part Name: ${selectedPartName}`;

            // Setup listener and switch screen
            setupRealtimeListener(selectedModel, selectedPartName);
            switchScreen('main');
            // Force change to engineer mode to encourage first data entry if fields were empty
            if (!model || !partName) {
                switchMode('engineer');
            }
        }
        
        /**
         * Switches visibility between the selection screen and the main app screen.
         * @param {string} screen - 'selection' or 'main'
         */
        function switchScreen(screen) {
            if (screen === 'selection') {
                selectionScreen.classList.remove('hidden');
                mainAppScreen.classList.add('hidden');
            } else {
                selectionScreen.classList.add('hidden'); // Fix: hide selection screen when showing main
                mainAppScreen.classList.remove('hidden');
                // Reset mode to view after filter selection
                switchMode('view'); 
            }
        }


        // --- Data Polling (Simulate Real-time) ---

        /**
         * Starts periodic polling for data updates.
         * @param {string} model - The selected machine model
         * @param {string} partName - The selected part name
         */
        function setupRealtimeListener(model, partName) {
            if (pollingTimer) {
                clearInterval(pollingTimer); 
            }
            if (!isAuthReady || !model || !partName) return;

            // Immediate fetch upon setup
            fetchAndRenderData(model, partName);

            // Set up polling interval
            pollingTimer = setInterval(() => {
                fetchAndRenderData(model, partName, true); // Silent fetch
            }, POLLING_INTERVAL);
        }
        
        /**
         * Fetches data and renders the list
         * @param {string} model 
         * @param {string} partName 
         * @param {boolean} silent - If true, skip showing main loading indicator
         */
        async function fetchAndRenderData(model, partName, silent = false) {
             if (!silent) showLoading();
             
             const result = await fetchSheetData('read_filtered', model, partName);
             
             if (!silent) hideLoading();

             if (result.success && result.data) {
                 renderConditionList(result.data.records || []);
             } else if (!silent) {
                 // Only show error if it's the main (non-silent) fetch
                 if (!WEB_APP_URL || !WEB_APP_URL.includes('xxxxxxxx')) {
                    showError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Condition Machine ‡πÑ‡∏î‡πâ');
                 }
                 renderConditionList([]); // Clear table on error
             }
        }

        /**
         * Saves or updates a machine condition record
         * @param {Object} data - The data object from the form
         * @param {string} docId - The row index for update, or null for new record
         */
        async function saveCondition(data, docId) {
            if (!isAuthReady) return;

            // The docId here is the row index in the sheet (starting from 2 for data rows)
            data.RowIndex = docId ? parseInt(docId) : null;
            
            const result = await postSheetData('save', data);

            if (result.success) {
                showStatusMessage(docId ? '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                clearForm();
                // Force data refetch after save
                fetchAndRenderData(selectedModel, selectedPartName);
                fetchUniqueCombinations(); // In case a new Model/PartName was added
            } else {
                showError('‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }
        }

        /**
         * Deletes a machine condition record
         * @param {string} docId - The row index to delete
         */
        window.deleteCondition = async (docId) => {
            if (!confirmAction('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?')) {
                return;
            }

            if (!isAuthReady) return;

            const data = { RowIndex: parseInt(docId) };
            const result = await postSheetData('delete', data);

            if (result.success) {
                showStatusMessage('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', false);
                // Force data refetch after delete
                fetchAndRenderData(selectedModel, selectedPartName);
                fetchUniqueCombinations(); // Re-check filter options
            } else {
                showError('‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
            }
        }
        

        // --- UI Rendering and Interaction (Mostly Unchanged) ---

        /**
         * Populates the form fields for editing an existing record.
         * @param {string} docId - The row index to edit
         * @param {Object} data - The data object
         */
        window.editCondition = (docId, data) => {
            document.getElementById('doc-id').value = docId;
            // Model and PartName are already set from the filter state
            document.getElementById('Model').value = data.Model || '';
            document.getElementById('PartName').value = data.PartName || '';
            document.getElementById('ProcessNo').value = data.ProcessNo || '';
            document.getElementById('MachineNo').value = data.MachineNo || '';
            document.getElementById('ProcessName').value = data.ProcessName || '';
            document.getElementById('ThreadNo').value = data.ThreadNo || '';
            document.getElementById('NeedleNo').value = data.NeedleNo || '';
            document.getElementById('StitchLength').value = data.StitchLength || '';
            document.getElementById('UpperTension').value = data.UpperTension || '';
            document.getElementById('LowerTension').value = data.LowerTension || '';
            document.getElementById('OuterFootPressure').value = data.OuterFootPressure || '';
            document.getElementById('InnerFootPressure').value = data.InnerFootPressure || '';
            document.getElementById('StopperDistance').value = data.StopperDistance || '';
            document.getElementById('AirPressure').value = data.AirPressure || '';
            document.getElementById('SpeedRPM').value = data.SpeedRPM || '';
            document.getElementById('ManSkill').value = data.ManSkill || '';
            
            analysisOutputContainer.classList.add('hidden');
            analysisText.innerHTML = '';

            submitBtn.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            switchMode('engineer');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /**
         * Clears the form and resets to 'New Record' mode.
         */
        function clearForm() {
            conditionForm.reset();
            // Important: Model and PartName fields must retain filter values (or the default set when bypassing filter)
            ModelInput.value = selectedModel;
            PartNameInput.value = selectedPartName;
            
            document.getElementById('doc-id').value = '';
            submitBtn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            analysisOutputContainer.classList.add('hidden');
            analysisText.innerHTML = '';
        }

        /**
         * Renders the list of conditions in the table
         * @param {Array} conditions - Array of condition objects
         */
        function renderConditionList(conditions) {
            conditionList.innerHTML = '';
            
            // Update the no-data-row text based on filter presence
            if (selectedModel && selectedPartName) {
                 document.getElementById('no-data-row').children[0].textContent = `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Condition Machine ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Model: ${selectedModel}, Part Name: ${selectedPartName}`;
            }

            if (conditions.length === 0) {
                noDataRow.classList.remove('hidden');
                return;
            }
            noDataRow.classList.add('hidden');

            conditions.forEach(data => {
                // The 'id' in this case is the Row Index from the sheet
                const docId = data.id; 
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition duration-100';

                // Combine Model / Part Name (now fixed for the filtered view)
                tr.innerHTML += `<td class="font-medium text-gray-900">${data.Model || '-'} <br><span class="text-xs text-gray-500">${data.PartName || '-'}</span></td>`;
                
                // Render remaining fields
                tr.innerHTML += `<td>${data.ProcessNo || '-'}</td>`;
                tr.innerHTML += `<td>${data.MachineNo || '-'}</td>`;
                tr.innerHTML += `<td>${data.ProcessName || '-'}</td>`;
                tr.innerHTML += `<td>${data.ThreadNo || '-'}</td>`;
                tr.innerHTML += `<td>${data.NeedleNo || '-'}</td>`;
                tr.innerHTML += `<td>${data.StitchLength || '-'}</td>`;
                tr.innerHTML += `<td class="text-blue-600">${data.UpperTension || '-'}</td>`;
                tr.innerHTML += `<td class="text-blue-600">${data.LowerTension || '-'}</td>`;
                tr.innerHTML += `<td class="text-red-600">${data.OuterFootPressure || '-'}</td>`;
                tr.innerHTML += `<td class="text-red-600">${data.InnerFootPressure || '-'}</td>`;
                tr.innerHTML += `<td>${data.StopperDistance || '-'}</td>`;
                tr.innerHTML += `<td>${data.AirPressure || '-'}</td>`;
                tr.innerHTML += `<td>${data.SpeedRPM || '-'}</td>`;
                tr.innerHTML += `<td class="font-bold text-green-600">${data.ManSkill || '-'}</td>`;

                // Actions Column (Visible only in Engineer Mode)
                const actionsTd = document.createElement('td');
                actionsTd.id = `actions-${docId}`;
                actionsTd.className = 'flex space-x-2 hidden'; 
                
                const editBtn = document.createElement('button');
                editBtn.className = 'text-blue-500 hover:text-blue-700 p-1 rounded-full hover:bg-blue-100 transition';
                editBtn.title = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
                editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-3.586 3.586l-7.78 7.78a1 1 0 00-.232.398l-1 4a1 1 0 001.26 1.26l4-1a1 1 0 00.398-.232l7.78-7.78-2.828-2.828z" /></svg>`;
                editBtn.onclick = () => window.editCondition(docId, data);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition';
                deleteBtn.title = '‡∏•‡∏ö';
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 7a1 1 0 012 0v5a1 1 0 11-2 0V7zm6 0a1 1 0 11-2 0v5a1 1 0 112 0V7z" clip-rule="evenodd" /></svg>`;
                deleteBtn.onclick = () => window.deleteCondition(docId);

                actionsTd.appendChild(editBtn);
                actionsTd.appendChild(deleteBtn);
                tr.appendChild(actionsTd);
                
                // TTS Button Column
                const ttsTd = document.createElement('td');
                const ttsBtn = document.createElement('button');
                ttsBtn.className = 'tts-button px-3 py-1 rounded-full text-xs font-semibold';
                ttsBtn.title = '‡∏ü‡∏±‡∏á‡∏Ñ‡πà‡∏≤ Condition';
                ttsBtn.innerHTML = `üîä ‡∏ü‡∏±‡∏á`;
                ttsBtn.onclick = (e) => window.speakCondition(data, e.currentTarget);
                ttsTd.appendChild(ttsBtn);
                tr.appendChild(ttsTd);

                conditionList.appendChild(tr);
            });

            switchMode(currentMode);
        }

        /**
         * Switches the application's operating mode (Unchanged)
         * @param {string} mode - 'engineer' or 'view'
         */
        function switchMode(mode) {
            currentMode = mode;

            const engineerBtn = document.getElementById('mode-engineer');
            const viewBtn = document.getElementById('mode-view');
            
            // Select only the direct children td elements in the list body (excluding header)
            // Note: The index 16 is fixed based on the total columns (15 data + 1 action)
            const allActionCells = document.querySelectorAll('#condition-list tr td:nth-child(16)');
            const allTTSCells = document.querySelectorAll('#condition-list tr td:last-child');
            const ttsHeader = document.querySelector('thead tr th:last-child');

            if (mode === 'engineer') {
                engineerModeDiv.classList.remove('hidden');
                engineerBtn.classList.add('bg-blue-600', 'text-white');
                viewBtn.classList.remove('bg-blue-600', 'text-white');
                viewBtn.classList.add('bg-gray-200', 'text-gray-700');
                
                tableActionsHeader.classList.remove('hidden');
                allActionCells.forEach(td => td.classList.remove('hidden'));

                // Hide TTS column in engineer mode
                ttsHeader.classList.add('hidden');
                allTTSCells.forEach(td => td.classList.add('hidden'));

            } else { // 'view' mode
                engineerModeDiv.classList.add('hidden');
                viewBtn.classList.add('bg-blue-600', 'text-white');
                engineerBtn.classList.remove('bg-blue-600', 'text-white');
                engineerBtn.classList.add('bg-gray-200', 'text-gray-700');
                
                tableActionsHeader.classList.add('hidden');
                allActionCells.forEach(td => td.classList.add('hidden'));

                // Show TTS column in view mode
                ttsHeader.classList.remove('hidden');
                allTTSCells.forEach(td => td.classList.remove('hidden'));
            }
        }

        // --- Event Listeners ---

        conditionForm.addEventListener('submit', (e) => {
            e.preventDefault();

            const data = {};
            const docId = document.getElementById('doc-id').value;

            // Collect all fields
            fields.forEach(field => {
                const element = document.getElementById(field);
                if (element) {
                    data[field] = element.value.trim() || null;
                    if (element.type === 'number' && data[field] !== null) {
                        data[field] = parseFloat(data[field]);
                    }
                    if (field === 'Model' || field === 'PartName') {
                         data[field] = data[field] || selectedModel; // Ensure filter fields use the current filter state/default
                    }
                }
            });

            saveCondition(data, docId);
        });

        document.getElementById('generate-analysis-btn').addEventListener('click', generateAnalysis);
        document.getElementById('clear-form-btn').addEventListener('click', clearForm);
        document.getElementById('mode-engineer').addEventListener('click', () => switchMode('engineer'));
        document.getElementById('mode-view').addEventListener('click', () => switchMode('view'));

        // New Selection Listeners
        submitSelectionBtn.addEventListener('click', handleSelectionSubmit);
        resetFilterBtn.addEventListener('click', () => {
            // Stop polling
            if (pollingTimer) {
                clearInterval(pollingTimer); 
                pollingTimer = null;
            }
            // Clear filter state
            selectedModel = null;
            selectedPartName = null;
            modelSelect.value = '';
            partNameSelect.value = '';

            // Go back to selection screen and re-fetch options
            fetchUniqueCombinations();
            switchScreen('selection');
        });


        // Initialize App
        initializeApp();
        switchScreen('selection'); // Start on the selection screen

    </script>
</body>
</html>
